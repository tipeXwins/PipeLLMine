338d337
<         auto ctrlmask = get_control_mask(ctrl);
346c345
<                     apply_term(tup.first, ids, {});
---
>                     apply_term(tup.first, ids, ctrl);
358,361c357,358
<                     if ((j & ctrlmask) == ctrlmask){
<                         output_state[j] += update[j];
<                         nrm_change += std::norm(update[j]);
<                     }
---
>                     output_state[j] += update[j];
>                     nrm_change += std::norm(update[j]);
367,368c364
<                 if ((j & ctrlmask) == ctrlmask)
<                     output_state[j] *= correction;
---
>                 output_state[j] *= correction;
